name: Build VPP Images

on:
  push:
    branches: 
      - master
  pull_request:
    branches: 
      - master
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  build-vpp-images:
    name: "VPP (${{ matrix.tag }}) - ${{ matrix.method }}"
    runs-on: ubuntu-latest
    env:
      DOCKER_REPO: fdio/vpp
      TAG: ${{ matrix.tag }}
    strategy:
      fail-fast: false
      matrix:
        tag: ['master', 'latest', '24.06', '24.02', '23.10', '23.06']
        method: ['deb']  # Only testing 'deb', fallback to 'apt' happens inside Dockerfile

    steps:
    - name: "Checkout Repository"
      uses: actions/checkout@v3
      with:
        path: vpp  # Ensure repository is checked out into the 'vpp' directory

    - name: "Print Debugging Info"
      run: |
        echo "Current directory: $(pwd)"
        echo "GitHub Workspace: $GITHUB_WORKSPACE"
        ls -lah
        cd vpp && ls -lah

    - name: "Verify Dockerfile Exists"
      run: |
        cd vpp/custom
        if [ ! -f Dockerfile ]; then
          echo "🚨 ERROR: Dockerfile not found in $(pwd). Check the repository structure."
          exit 1
        fi

    - name: "Set Up Dependencies"
      run: |
        sudo apt-get update
        sudo apt-get install -y apt-transport-https ca-certificates curl gnupg iproute2 iputils-ping

    - name: "Build Docker Image (${{ matrix.method }})"
      run: |
        cd vpp
        docker build --build-arg VPP_INSTALL_METHOD=${{ matrix.method }} -f custom/Dockerfile -t "$DOCKER_REPO:${{ matrix.tag }}-${{ matrix.method }}" .

    - name: "Check Installed Packages and Debug"
      run: |
        cd vpp
        docker run --rm "$DOCKER_REPO:${{ matrix.tag }}-${{ matrix.method }}" bash -c "
          echo 'Checking installed VPP packages...';
          dpkg -l | grep vpp || echo '⚠️ No VPP packages found!';
          cat /vpp/version || echo '⚠️ No version file found!';
        "

    - name: "Publish Image to Docker Hub"
      if: github.event_name != 'pull_request'
      run: |
        cd vpp
        export VPP_VERSION=$(docker run --rm "$DOCKER_REPO:${{ matrix.tag }}-${{ matrix.method }}" cat /vpp/version | cut -d'~' -f1,2 | sed -e 's/~/./g')
        docker tag "$DOCKER_REPO:${{ matrix.tag }}-${{ matrix.method }}" "$DOCKER_REPO:$VPP_VERSION-${{ matrix.method }}"
        docker images "$DOCKER_REPO"
        if [ "$GITHUB_EVENT_NAME" == "schedule" ] && curl -sSflL "https://index.docker.io/v1/repositories/$DOCKER_REPO/tags/$VPP_VERSION-${{ matrix.method }}" >/dev/null; then
          echo "Image $DOCKER_REPO:$VPP_VERSION-${{ matrix.method }} is already published."
        else
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          docker push "$DOCKER_REPO:$VPP_VERSION-${{ matrix.method }}"
          docker push "$DOCKER_REPO:${{ matrix.tag }}-${{ matrix.method }}"
        fi
