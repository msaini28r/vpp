FROM ubuntu:22.04 as builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    make \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Copy VPP build artifacts
COPY build-root/build-vpp-native/vpp/ /vpp-install/

# Final image
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    iproute2 \
    iputils-ping \
    && rm -rf /var/lib/apt/lists/*

# Copy VPP from builder
COPY --from=builder /vpp-install /usr/local/

# Create required directories
RUN mkdir -p /var/log/vpp /var/run/vpp

# Copy startup configuration
COPY build/docker/startup.conf /etc/vpp/startup.conf

# Add version file
ARG VPP_VERSION
RUN echo "${VPP_VERSION}" > /vpp/version

EXPOSE 5002

CMD ["/usr/local/bin/vpp", "-c", "/etc/vpp/startup.conf"]